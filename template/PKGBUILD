# Generated by [gen_mc_aur_pkg](https://github.com/isac322/gen_mc_aur_pkg)

# Maintainer: Byeonghoon Yoo <bh322yoo@gmail.com>

# Based on the 'forge-server' AUR package by:
# Maintainer: Nitroretro <nitroretro@protonmail.com>

# Based on the `minecraft-server` AUR package by:
# Maintainer: Gordian Edenhofer <gordian.edenhofer@gmail.com>
# Contributer: Philip Abernethy <chais.z3r0@gmail.com>
# Contributer: sowieso <sowieso@dukun.de>


pkgname='${pkg_name}'
pkgver='${mc_ver}_${srv_ver}'
pkgrel=${pkg_rel}
pkgdesc="Minecraft ${mc_ver} ${srv_type} server unit files, script, and jar"
arch=('any')
url="https://fabricmc.net"
license=("Apache")
depends=('java-runtime-headless>=16' 'tmux' 'sudo' 'bash' 'awk' 'sed')
optdepends=("tar: needed in order to create world backups"
	"netcat: required in order to suspend an idle server")
provides=("${srv_type}-server=${pkgver}")
backup=('etc/conf.d/${srv_id}')
# See https://launchermeta.mojang.com/mc/game/version_manifest.json for a list of all releases
source=("${srv_type}-installer-${srv_ver}.jar"::"https://maven.fabricmc.net/net/fabricmc/fabric-installer/${srv_ver}/fabric-installer-${srv_ver}.jar"
	"${daemon_name}-backup.service"
	"${daemon_name}-backup.timer"
	"${daemon_name}.service"
	"${daemon_name}.sysusers"
	"${daemon_name}.tmpfiles"
	"${daemon_name}.conf"
	"${daemon_name}.sh")
noextract=("fabric-installer-${srv_ver}.jar")
sha512sums=(
            'TODO'
            '${sha_backup_svc}'
            '${sha_backup_timer}'
            '${sha_srv_svc}'
            '${sha_sysusers}'
            '${sha_tmpfiles}'
            '${sha_conf}'
            '${sha_sh}')

_server_root="/srv/${srv_id}"

prepare() {
	java -Duser.home="${srcdir}" -jar "fabric-installer-${srv_ver}.jar" server -mcversion ${mc_ver} -downloadMinecraft
}

package() {
	install -Dm644 ${daemon_name}.conf             "${pkgdir}/etc/conf.d/${srv_id}"
	install -Dm755 ${daemon_name}.sh               "${pkgdir}/usr/bin/${daemon_name}"
	install -Dm644 ${daemon_name}.service          "${pkgdir}/usr/lib/systemd/system/${daemon_name}.service"
	install -Dm644 ${daemon_name}-backup.service   "${pkgdir}/usr/lib/systemd/system/${daemon_name}-backup.service"
	install -Dm644 ${daemon_name}-backup.timer     "${pkgdir}/usr/lib/systemd/system/${daemon_name}-backup.timer"
	install -Dm644 ${daemon_name}.sysusers         "${pkgdir}/usr/lib/sysusers.d/${daemon_name}.conf"
	install -Dm644 ${daemon_name}.tmpfiles         "${pkgdir}/usr/lib/tmpfiles.d/${daemon_name}.conf"
	install -Dm644 server.jar                      "${pkgdir}${_server_root}/server.jar"
	install -Dm644 fabric-server-launch.jar        "${pkgdir}${_server_root}/fabric-server-launch.jar"

	# Link the log files
	mkdir -p "${pkgdir}/var/log/"
	install -dm2755 "${pkgdir}/${_server_root}/logs"
	ln -s "${_server_root}/logs" "${pkgdir}/var/log/${srv_id}"

	# Give the group write permissions and set user or group ID on execution
	chmod g+ws "${pkgdir}${_server_root}"
}
